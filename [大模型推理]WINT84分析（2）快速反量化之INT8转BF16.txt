[å¤§æ¨¡å‹æ¨ç†]ğŸ”¥WINT8/4åˆ†æï¼ˆ2ï¼‰ï¼šå¿«é€Ÿåé‡åŒ–ä¹‹INT8è½¬BF16
DefTruth
DefTruthâ€‹
ä¿æŒå­¦ä¹ ï¼Œæ°¸è¿œå°‘å¹´ã€‚
å·²å…³æ³¨
8 äººèµåŒäº†è¯¥æ–‡ç« 
â€‹
ç›®å½•
æ”¶èµ·
0x00 å‰è¨€
0x01 BF16çš„ç‰¹åˆ«å¤„ç†
0x02 INT8è½¬BF16æºç åˆ†æ
0x03 æ•´ä½“å¤„ç†
0x04 æ€»ç»“
0x00 å‰è¨€
å…³é”®è¯ï¼šå¿«é€Ÿåé‡åŒ–ã€__byte_permã€BF16ã€fp32_base

å‰2ç¯‡æ–‡ç« åˆ†æäº†NVIDIAåœ¨MoEå¤§æ¨¡å‹æ¨ç†ä¸­ç”¨åˆ°çš„å¿«é€Ÿåé‡åŒ–æŠ€æœ¯çš„åŸç†ï¼Œä»¥åŠINT8å¿«é€Ÿåé‡åŒ–åˆ°FP16çš„å…·ä½“å®ç°ã€‚
FP16å’ŒBF16éƒ½æ˜¯å¤§æ¨¡å‹æ¨ç†ä¸­å¸¸ç”¨çš„æ•°æ®ç±»å‹ï¼Œç”±äºBF16å°¾æ•°åªæœ‰7ä½ï¼Œæ— æ³•ç›´æ¥å­˜å‚¨8ä½çš„int8æ•°æ®ï¼Œå› æ­¤NV FasterTransformerä¸­è¿›è¡Œäº†ç‰¹æ®Šå¤„ç†ã€‚
è¿™ç¯‡ç»§ç»­è®²ä¸€ä¸‹INT8å¿«é€Ÿåé‡åŒ–åˆ°BF16å…·ä½“æ˜¯æ€ä¹ˆå¤„ç†çš„ã€‚å¦å¤–ï¼Œã€å¼ºçƒˆå»ºè®®ã€‘å…ˆé˜…è¯»å®Œå‰2ç¯‡ï¼Œå†æ¥é˜…è¯»æœ¬ç¯‡å†…å®¹ã€‚

[å¤§æ¨¡å‹æ¨ç†]ğŸ”¥WINT8/4åˆ†æï¼ˆ0ï¼‰: é€šä¿—æ˜“æ‡‚è®²è§£-å¿«é€Ÿåé‡åŒ–ç®—æ³•
[å¤§æ¨¡å‹æ¨ç†]ğŸ”¥WINT8/4åˆ†æï¼ˆ1ï¼‰ï¼šPRMTæŒ‡ä»¤è¯¦è§£åŠFasterTransformeræºç è§£æ

0x01 BF16çš„ç‰¹åˆ«å¤„ç†
é¦–å…ˆéœ€è¦æ¸…æ¥šBF16å’ŒFP16çš„åŒºåˆ«ï¼Œç½‘ä¸Šæœ‰å›¾ç›´æ¥æ‹¿æ¥ç”¨ï¼Œä¾µåˆ ã€‚
é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒBF16çš„bitä½æ„æˆä¸ºï¼šç¬¦å·ä½1ä½ã€æŒ‡æ•°ä½8ä½ï¼ˆå’ŒFP32æŒ‡æ•°ä½ä¸€æ ·ï¼‰ã€å°¾æ•°ä½7ä½ï¼ˆå°äºFP16çš„10ä½ï¼‰ã€‚
BF16çš„ç‰¹ç‚¹å†³å®šäº†æˆ‘ä»¬ä¸èƒ½ç›´æ¥ä½¿ç”¨FP16çš„æ–¹å¼è¿›è¡Œå¤„ç†ã€‚è¿™æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ
18.webp  å›¾å€Ÿï¼Œä¾µåˆ 

BF16å°¾æ•°ä½åªæœ‰7ä½ï¼Œæ— æ³•å­˜å‚¨INT8ï¼Œå¦‚ä½•å¤„ç†ï¼Ÿ
éœ€è¦ä¿å­˜uint8çš„äºŒè¿›åˆ¶bitsï¼Œè‡³å°‘éœ€è¦8ä½æ‰å¯ä»¥ï¼Œè€ŒBF16çš„å°¾æ•°åªæœ‰7ä½ã€‚å› æ­¤ä¸èƒ½ç›´æ¥å°†uint8ç›´æ¥ä¿å­˜åœ¨BF16çš„å°¾æ•°éƒ¨åˆ†ã€‚
é‚£ä¹ˆæ€ä¹ˆåŠå‘¢ï¼ŸFasterTransformerçš„åšæ³•æ˜¯ä½¿ç”¨FP32ä½œä¸ºæ¡¥æ¢ã€‚æˆ‘ä»¬çŸ¥é“FP32çš„å°¾æ•°éƒ¨åˆ†æœ‰23ä½ï¼Œå®Œå…¨å¯ä»¥å®¹çº³uint8ç±»å‹çš„8ä¸ªbitsã€‚
è€Œä¸”ï¼ŒFP32 è½¬æ¢æˆ BF16 éå¸¸ä¾¿æ·ï¼Œå› ä¸º FP32 å’Œ BF16 çš„æŒ‡æ•°ä½æ•°ä¸€æ ·ï¼Œéƒ½æ˜¯8ä½ï¼Œè€Œå°¾æ•°éƒ¨åˆ† FP32 çš„ä½æ•°ï¼ˆ23ä½å°¾æ•°ï¼‰å¤§äºBF16ï¼ˆ7ä½å°¾æ•°ï¼‰ï¼›
å› æ­¤FP32 å’Œ BF16 çš„æŒ‡æ•°ä½è¡¨è¾¾çš„åŠ¨æ€èŒƒå›´æ˜¯ä¸€æ ·çš„ã€‚FP32 è½¬ BF16 åªéœ€è¦å¯¹FP32è¿›è¡Œæˆªæ–­ï¼Œä¿ç•™é«˜16ä½å³å¯ã€‚

    UINT8 -> FP32_Expr = FP32_Base_Magic_Num bits | UINT8 bits
          -> FP32_Expr_Ori = FP32_Expr - (FP32_Base_Magic_Num + 128)
          -> BF16_Expr_Ori = [Truncate FP32_Expr_Ori High 16 bits]

0x02 INT8è½¬BF16æºç åˆ†æ

å…³äºäº¤ç»‡çš„é‡åŒ–æƒé‡åœ¨å†…å­˜ä¸­çš„å¸ƒå±€ã€PRMTæŒ‡ä»¤çš„è§£æï¼ˆBF16è½¬æ¢ä¸­ç”¨åˆ°çš„__byte_permæ˜¯PRMTçš„CUDA Math APIç‰ˆæœ¬ï¼ŒåŠŸèƒ½ä¸€è‡´ï¼‰ã€è§£äº¤ç»‡ç­‰çŸ¥è¯†ï¼Œ
åœ¨æœ¬æ–‡ä¸å†é‡å¤ï¼Œè¯·è¯»è€…è‡ªè¡Œé˜…è¯»ï¼š
DefTruthï¼š[å¤§æ¨¡å‹æ¨ç†] WINT8/4åˆ†æï¼ˆ1ï¼‰ï¼šPRMTæŒ‡ä»¤è¯¦è§£åŠFasterTransformeræºç è§£æï¼›
æºç åœ¨NV FasterTransformerä¸­çš„FastInterleavedAndBiasedNumericArrayConverterç»“æ„ä½“ã€‚

    template<>
    struct FastInterleavedAndBiasedNumericArrayConverter<bfloat16_t, uint8_t, 4> {
        using result_type = Array<bfloat16_t, 4>;
        using source_type = Array<uint8_t, 4>;

æ ¸å¿ƒå®ç°åœ¨convertå‡½æ•°ä¸Šï¼Œå’ŒFP16çš„ç±»ä¼¼çš„æ˜¯ï¼ŒINT8åˆ°BF16çš„åé‡åŒ–å‡½æ•°ï¼Œä¹Ÿéœ€è¦è´Ÿè´£å¤„ç†å‡ ä¸ªäº‹æƒ…ï¼Œ
å³ï¼šå¯¹äº¤ç»‡ä¿å­˜çš„æƒé‡ï¼Œåé‡åŒ–å¹¶åŒæ—¶è§£äº¤ç»‡ã€‚
æˆ‘ä»¬ç›´æ¥æ¥çœ‹æºç å§ï¼Œè¿™é‡Œæä¾›è¿™ä¸ªå‡½æ•°çš„ä¸€ä¸ªå¢åŠ äº†ä¸ªäººè¯¦ç»†æ³¨é‡Šçš„ç‰ˆæœ¬ã€‚

 CUTLASS_DEVICE
    static result_type convert(source_type const& source)
    {
.....

ä»£ç é¦–å…ˆå¯¹CUDA_ARCHè¿›è¡Œäº†åˆ¤æ–­ï¼Œåªæœ‰sm80åŠä»¥ä¸Šæ‰ä¼šæ”¯æŒBF16ï¼›
ç„¶åä½¿ç”¨0x4B000000ä½œä¸ºFP32çš„Magic Numberï¼Œè¿™ä¸ªæ•°å€¼çš„é€‰å–é€»è¾‘ï¼Œå’Œåœ¨FP16ä¸­çš„åˆ†ææ˜¯ä¸€è‡´çš„ï¼Œ
è¯·å‚è€ƒï¼šDefTruthï¼š[å¤§æ¨¡å‹æ¨ç†] WINT8/4åˆ†æï¼ˆ0ï¼‰:é€šä¿—æ˜“æ‡‚è®²è§£-å¿«é€Ÿåé‡åŒ–ç®—æ³•ï¼Œ
å› ä¸ºFP32çš„å°¾æ•°æ˜¯23ä½ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨0x4B000000ï¼š

    0x4B000000 -> 0b 0 10010110 0000...0000
    10010110   -> 150 -> 150 - 127 = 23 -> 2^23 = 8388608
    + 128      -> 8388608 + 128 = 8388736

å¦‚ä¸Šåˆ†æï¼Œä½¿ç”¨0x4B000000æ„å‘³ç€æŒ‡æ•°éƒ¨åˆ†ä»£è¡¨çš„ç²¾ç¡®å€¼ä¸º8388608ï¼Œæœ€åè¿˜è¦é¢å¤–å‡å»ä¸€ä¸ª128ï¼ˆé‡åŒ–ï¼‰ï¼Œ
å› æ­¤éœ€è¦è¢«å‡å»çš„æ•°å€¼ä¸ºï¼š8388608 + 128 = 8388736ã€‚
é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œ
æºç ä½¿ç”¨äº†__byte_permå‡½æ•°æ¥æ„é€ ä¸€ç»„FP32è¡¨è¾¾çš„æ•°å€¼ï¼ˆ__byte_permæ˜¯PRMTçš„CUDA Math APIç‰ˆæœ¬ï¼ŒåŠŸèƒ½ä¸€è‡´ï¼‰ï¼š

    // {b, a} = {{0x4B, 0x00, 0x00, 0x00},{e3, e1, e2, e0}} index 7 -> 0
    uint32_t* fp32_intermediates_casted = reinterpret_cast<uint32_t*>(fp32_intermediates);
    fp32_intermediates_casted[0]        = __byte_perm(i8s, fp32_base, 0x7650);  // 0x{4B0000}{e0}
    fp32_intermediates_casted[1]        = __byte_perm(i8s, fp32_base, 0x7652);  // 0x{4B0000}{e1}
    fp32_intermediates_casted[2]        = __byte_perm(i8s, fp32_base, 0x7651);  // 0x{4B0000}{e2}
    fp32_intermediates_casted[3]        = __byte_perm(i8s, fp32_base, 0x7653);  // 0x{4B0000}{e3}

PRMTä¸­ç”¨åˆ°çš„{b, a}ï¼Œæ­¤æ—¶çš„æ’å¸ƒä¸º{{0x4B, 0x00, 0x00, 0x00},{e3, e1, e2, e0}}ï¼Œ
åŸç†è¯·å‚è€ƒï¼šDefTruthï¼š[å¤§æ¨¡å‹æ¨ç†] WINT8/4åˆ†æï¼ˆ1ï¼‰ï¼šPRMTæŒ‡ä»¤è¯¦è§£åŠFasterTransformeræºç è§£æï¼Œ
è¿™æ˜¯ç”±äºæƒé‡å…ˆè¢«äº¤ç»‡ä¿å­˜çš„åŸå› å¯¼è‡´çš„ã€‚
åœ¨åé‡åŒ–æ—¶ï¼Œè¦åŒæ—¶è§£äº¤ç»‡ï¼Œ
å³å°†{e3, e1, e2, e0}æ¢å¤æˆ{e3, e2, e1, e0}ã€‚ç»è¿‡__byte_permåï¼Œå°±è·å¾—äº† Y_FP32 = 0x4B000000 | Y çš„è¡¨è¾¾ã€‚
æ¥ä¸‹æ¥ï¼Œå°±æ˜¯ç”¨Y_FP32å‡å»8388736ï¼Œè·å¾—åŸå§‹int8å€¼çš„FP32è¡¨è¾¾ã€‚
è¿™é‡Œä½¿ç”¨äº†CUTLASS_PRAGMA_UNROLLå¯¹å››æ¬¡çš„å¾ªç¯è¿›è¡Œå±•å¼€ã€‚

    CUTLASS_PRAGMA_UNROLL
    for (int ii = 0; ii < 4; ++ii) {
         fp32_intermediates[ii] -= 8388736.f; // f32 arr {e3, e2, e1, e0}
    }

æœ€åï¼Œå†æ¬¡ä½¿ç”¨__byte_permå¯¹FP32è¿›è¡Œæˆªæ–­ï¼Œè¿™é‡Œå®ç°æˆï¼ŒåŒæ—¶å¯¹ä¸¤ä¸ªFP32ï¼Œåªå–ä»–ä»¬å„è‡ªé«˜ä½çš„2ä¸ªå­—èŠ‚ï¼Œä¿ç•™ä¸ºBF16ã€‚
å…¶ä¸­0x7632ä¸­çš„0x76è¡¨ç¤ºé€‰å–fp32_intermediates_casted[2* ii +1]çš„é«˜2å­—èŠ‚ï¼Œå¹¶å°†å…¶ä¿å­˜åœ¨bf16_result_ptr[ii]çš„é«˜2å­—èŠ‚ï¼›
0x32è¡¨ç¤ºé€‰å–fp32_intermediates_casted[2* ii +0]çš„é«˜2å­—èŠ‚ï¼Œå¹¶å°†å…¶ä¿å­˜åœ¨bf16_result_ptr[ii]çš„ä½2å­—èŠ‚ã€‚
ä»è€Œæ„æˆäº†ä¸€ä¸ª32bitå¯„å­˜å™¨pack 2ä¸ªBF16æ•°æ®çš„å½¢å¼ã€‚

    CUTLASS_PRAGMA_UNROLL
    for (int ii = 0; ii < 2; ++ii) {
        bf16_result_ptr[ii] =
         __byte_perm(fp32_intermediates_casted[2 * ii + 0], fp32_intermediates_casted[2 * ii + 1], 0x7632);
         // keep high 16 bits as BF16
    }

è‡³æ­¤ï¼Œå°±å®Œæˆäº†4ä¸ªUINT8è½¬BF16çš„è¿‡ç¨‹ã€‚

0x03 æ•´ä½“å¤„ç†
ä¸Šè¾¹è®²çš„æ˜¯4ä¸ªuint8çš„åé‡åŒ–åˆ°BF16æ“ä½œï¼Œæˆ‘ä»¬æœ€åå†ç®€å•çœ‹ä¸‹æ•´ä½“ä¸Šæ˜¯æ€ä¹ˆå¤„ç†æ‰€æœ‰uint8é‡åŒ–æƒé‡çš„åé‡åŒ–çš„ã€‚

    template<int N>
    struct FastInterleavedAndBiasedNumericArrayConverter<bfloat16_t, uint8_t, N> {
        static constexpr int VEC_WIDTH = 4;
    .....

é¦–å…ˆï¼Œå®šä¹‰äº†deviceå‡½æ•°convertï¼Œæ¨¡æ¿FastInterleavedAndBiasedNumericArrayConverterç±»ä¸­ï¼Œæ¨¡æ¿å‚æ•°Nè¡¨ç¤ºuint8å…ƒç´ çš„ä¸ªæ•°ã€‚
è¯¥å‡½æ•°é¦–å…ˆæ˜¯æ£€æŸ¥Næ˜¯å¦æ˜¯4çš„å€æ•°ï¼ŒVEC_WIDTH=4ï¼Œä¹Ÿå°±æ˜¯æ”¯æŒNä¸º4çš„å€æ•°çš„æƒ…å†µã€‚
è¿™æ˜¯ç”±äºï¼Œåªå®ç°ä¸€æ¬¡æ€§å¤„ç†4ä¸ªå…ƒç´ çš„ç‰¹ä¾‹åŒ–çš„Converterï¼Œå³ï¼š

    FastInterleavedAndBiasedNumericArrayConverter<bfloat16_t, uint8_t, 4>;

ç„¶åï¼Œåœ¨convertå‡½æ•°å†…éƒ¨ï¼Œå®ä¾‹åŒ–äº†è¿™ä¸ªç‰¹ä¾‹åŒ–çš„Converterä¸ºï¼šconvert_vector_ï¼›
æœ€åï¼Œé€šè¿‡forå¾ªç¯æ¥æ¯4ä¸ªuint8å…ƒç´ ä¸€ç»„è¿›è¡Œå¤„ç†ï¼Œå¹¶ä¸”ä½¿ç”¨äº†CUTLASS_PRAGMA_UNROLLè¿›è¡Œäº†å¾ªç¯å±•å¼€ã€‚

    CUTLASS_PRAGMA_UNROLL
    for (int i = 0; i < N / VEC_WIDTH; ++i) {
       result_ptr[i] = convert_vector_(source_ptr[i]);
    }

è‡³æ­¤ï¼Œæ‰€æœ‰çš„uint8æƒé‡å°±è¢«å¤„ç†å®Œäº†ã€‚æœ€åï¼Œå…³äºæ•´ä½“çš„è°ƒç”¨é“¾è·¯ï¼Œåœ¨ä¸Šä¸€ç¯‡æœ‰å†™ï¼Œè¿™é‡Œä¸é‡å¤äº†ï¼Œ
è¯·å‚è€ƒï¼šDefTruthï¼š[å¤§æ¨¡å‹æ¨ç†] WINT8/4åˆ†æï¼ˆ1ï¼‰ï¼šPRMTæŒ‡ä»¤è¯¦è§£åŠFasterTransformeræºç è§£æ

0x04 æ€»ç»“
æœ¬æ–‡æ•´ç†äº†è¯¦ç»†è®²è§£äº†UINT8åˆ°BF16çš„å¿«é€Ÿåé‡åŒ–çš„å…·ä½“å®ç°ï¼Œå¹¶ä¸”å¯¹æ¯”äº†BF16å’ŒFP16åœ¨å¤„ç†ä¸Šçš„åŒºåˆ«ã€‚
ä½†æ˜¯è¿™é‡Œç›®å‰ä¸ºæ­¢åªè®²åˆ°äº†int8æƒé‡çš„åé‡åŒ–ï¼Œint4æƒé‡åé‡åŒ–ä»¥åŠè¯¦ç»†çš„è°ƒç”¨æµç¨‹è¿˜æ²¡æåˆ°ï¼Œè¿™å°†ä¼šå†é¢å¤–å¼€å‡ ç¯‡æ–‡ç« åˆ†æã€‚

é™„å¤§æ¨¡å‹WINT8/4åˆ†æç³»åˆ—ï¼š

[å¤§æ¨¡å‹æ¨ç†]ğŸ”¥WINT8/4åˆ†æï¼ˆ0ï¼‰: é€šä¿—æ˜“æ‡‚è®²è§£-å¿«é€Ÿåé‡åŒ–ç®—æ³•
6 èµåŒ Â· 0 è¯„è®ºæ–‡ç« 

[å¤§æ¨¡å‹æ¨ç†]ğŸ”¥WINT8/4åˆ†æï¼ˆ1ï¼‰ï¼šPRMTæŒ‡ä»¤è¯¦è§£åŠFasterTransformeræºç è§£æ
12 èµåŒ Â· 1 è¯„è®ºæ–‡ç« 

[å¤§æ¨¡å‹æ¨ç†][20ç¯‡]ğŸ”¥LLMæ¨ç†è®ºæ–‡é›†v0.2-300é¡µPDFğŸ’¡
62 èµåŒ Â· 8 è¯„è®ºæ–‡ç« 

æŒç»­æ›´æ–°ï¼Œé”™å­—å…ˆæ›´åæ”¹......

ç¼–è¾‘äº 2023-10-01 11:27ãƒ»IP å±åœ°å¹¿ä¸œ